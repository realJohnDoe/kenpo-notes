<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{TITLE}}</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #fafafa;
      }
      svg {
        width: 100%;
        height: 100vh;
        display: block;
      }
      .txt {
        font-family: sans-serif;
        font-size: 1rem; /* Decreased font size for clock labels */
        fill: black;
      }
      #stepLabel {
        font-family: sans-serif;
        font-size: 1.5rem; /* Original size for YAML labels */
        fill: black;
      }
    </style>
  </head>
  <body>
    <!-- SVG placeholder â€“ the generator will inject shapes/text here -->
    {{SVG_CONTENT}}

    <script src="./anime.js"></script>
    <script>
      // Timeline data is injected by the generator
      const timelineData = {{TIMELINE_JSON}};
      const labelEl = document.getElementById('stepLabel');

      const mainTl = anime.timeline({autoplay:true, loop:false});

      let currentTimelineCursor = 0; // Tracks the end of the previous step's animations

      timelineData.forEach(step => {
        let stepDuration = 1000; // Default duration for person animations

        // Add person animations to the main timeline
        if (step.anims && step.anims.length > 0) {
          const firstAnimation = step.anims[0];
          stepDuration = firstAnimation.duration;
          mainTl.add(firstAnimation, currentTimelineCursor);
          for (let i = 1; i < step.anims.length; i++) {
            mainTl.add(step.anims[i], currentTimelineCursor);
          }
        }

        // Add label animations to the main timeline
        if (step.label && step.label.texts && step.label.texts.length > 0) {
          const timePerLabel = stepDuration / step.label.texts.length;
          const fadeDuration = 200;

          // Set position and text, then fade in for the first label
          mainTl.add({
            targets: labelEl,
            translateY: step.label.y,
            duration: 1,
            begin: () => { labelEl.textContent = step.label.texts[0]; }
          }, currentTimelineCursor);

          mainTl.add({
            targets: labelEl,
            opacity: 1,
            duration: fadeDuration,
            easing: 'linear'
          }, currentTimelineCursor);

          // Loop through subsequent labels for the current step
          for (let i = 1; i < step.label.texts.length; i++) {
            const labelText = step.label.texts[i];
            const prevLabelStartTime = currentTimelineCursor + (i * timePerLabel);

            // Fade out previous label
            mainTl.add({
              targets: labelEl,
              opacity: 0,
              duration: fadeDuration,
              easing: 'linear',
              complete: () => { labelEl.textContent = labelText; }
            }, prevLabelStartTime - fadeDuration);

            // Fade in new label
            mainTl.add({
              targets: labelEl,
              opacity: 1,
              duration: fadeDuration,
              easing: 'linear'
            }, prevLabelStartTime);
          }
        }

        // After all animations for a step, fade out the last label
        mainTl.add({
            targets: labelEl,
            opacity: 0,
            duration: 200,
            easing: 'linear'
        }, currentTimelineCursor + stepDuration - 200);

        currentTimelineCursor += stepDuration; // Advance the timeline for the next step
      });
    </script>
  </body>
</html>
